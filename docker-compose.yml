services:
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    entrypoint: ["/bin/bash", "/scripts/ollama-entrypoint.sh"]
    volumes:
      - ollama_data:/root/.ollama
      - ./scripts:/scripts:ro
    environment:
      - OLLAMA_FILTER_MODEL=${OLLAMA_FILTER_MODEL:-phi3:mini}
      - OLLAMA_ANALYSIS_MODEL=${OLLAMA_ANALYSIS_MODEL:-mistral:7b}
      - OLLAMA_NUM_PARALLEL=${OLLAMA_NUM_PARALLEL:-1}
    healthcheck:
      test: ["CMD-SHELL", "ollama list | grep -q ."]
      interval: 30s
      timeout: 10s
      retries: 40
      start_period: 300s
    restart: unless-stopped

  airflow:
    build:
      context: .
      dockerfile: Dockerfile.airflow
    container_name: airflow
    depends_on:
      ollama:
        condition: service_healthy
    environment:
      - AIRFLOW__CORE__EXECUTOR=${AIRFLOW__CORE__EXECUTOR:-SequentialExecutor}
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=${AIRFLOW__DATABASE__SQL_ALCHEMY_CONN:-sqlite:////opt/airflow/airflow.db}
      - AIRFLOW__CORE__FERNET_KEY=${AIRFLOW__CORE__FERNET_KEY:-change_me_to_a_real_fernet_key}
      - AIRFLOW__WEBSERVER__SECRET_KEY=${AIRFLOW__WEBSERVER__SECRET_KEY:-change_me_to_a_real_secret_key}
      - AIRFLOW__CORE__LOAD_EXAMPLES=${AIRFLOW__CORE__LOAD_EXAMPLES:-false}
      - AIRFLOW__CORE__LAZY_LOAD_PLUGINS=true
      - AIRFLOW__CORE__LAZY_DISCOVER_PROVIDERS=true
      - AIRFLOW__CORE__DAGS_FOLDER=/opt/airflow/dags
      - OLLAMA_HOST=ollama
      - OLLAMA_PORT=11434
      - OLLAMA_FILTER_MODEL=${OLLAMA_FILTER_MODEL:-phi3:mini}
      - OLLAMA_ANALYSIS_MODEL=${OLLAMA_ANALYSIS_MODEL:-mistral:7b}
      - SQLITE_DB_PATH=/data/investments.db
      - NOTIFICATION_BACKEND=${NOTIFICATION_BACKEND:-telegram}
      - NOTIFICATION_BACKENDS=${NOTIFICATION_BACKENDS:-["telegram"]}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID:-}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN:-}
      - TWILIO_WHATSAPP_FROM=${TWILIO_WHATSAPP_FROM:-}
      - MY_WHATSAPP_NUMBER=${MY_WHATSAPP_NUMBER:-}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - app_data:/data
      - app_logs:/app/logs
      - ./dags:/opt/airflow/dags:ro
      - ./src:/opt/airflow/src:ro
    ports:
      - "8080:8080"
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        airflow db migrate &&
        airflow users create --username admin --password admin --firstname Admin --lastname User --role Admin --email admin@example.com || true &&
        airflow scheduler &
        exec airflow webserver --port 8080
    restart: unless-stopped

  worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: worker
    dns:
      - 8.8.8.8
      - 8.8.4.4
    depends_on:
      ollama:
        condition: service_healthy
    environment:
      - OLLAMA_HOST=ollama
      - OLLAMA_PORT=11434
      - OLLAMA_FILTER_MODEL=${OLLAMA_FILTER_MODEL:-phi3:mini}
      - OLLAMA_ANALYSIS_MODEL=${OLLAMA_ANALYSIS_MODEL:-mistral:7b}
      - SQLITE_DB_PATH=/data/investments.db
      - NOTIFICATION_BACKEND=${NOTIFICATION_BACKEND:-telegram}
      - NOTIFICATION_BACKENDS=${NOTIFICATION_BACKENDS:-["telegram"]}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID:-}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN:-}
      - TWILIO_WHATSAPP_FROM=${TWILIO_WHATSAPP_FROM:-}
      - MY_WHATSAPP_NUMBER=${MY_WHATSAPP_NUMBER:-}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - app_data:/data
      - app_logs:/app/logs
    restart: "no"

volumes:
  ollama_data:
  app_data:
  app_logs:
